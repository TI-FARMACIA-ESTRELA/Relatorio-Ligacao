{% extends "base.html" %}
{% block title %}Relatório — {{ ym }}{% endblock %}

{% block content %}
<div class="container">
  <div class="header-row">
    <h1>Relatório — {{ ym }}</h1>
    <div class="actions">
      <a class="btn" href="{{ url_for('bp.public_index') }}">← Voltar</a>
      <a class="btn btn--success" href="{{ url_for('bp.export_excel', ym=ym) }}">Exportar Excel</a>
    </div>
  </div>

  <p class="muted">Chamadas consolidadas por loja (Televendas)</p>

  <div class="order-bar">
    <span>Ordenação:</span>
    <div class="btn-row">
  <a class="btn {{ 'active' if order=='loja' else '' }}"
     href="{{ url_for('bp.public_report', ym=ym, order='loja') }}">Por loja</a>

  <a class="btn {{ 'active' if order=='pct_desc' else '' }}"
     href="{{ url_for('bp.public_report', ym=ym, order='pct_desc') }}">% perda ↓</a>

  <a class="btn {{ 'active' if order=='recebidas_desc' else '' }}"
     href="{{ url_for('bp.public_report', ym=ym, order='recebidas_desc') }}">Recebidas ↓</a>

  <a class="btn {{ 'active' if order=='perdidas_desc' else '' }}"
     href="{{ url_for('bp.public_report', ym=ym, order='perdidas_desc') }}">Perdidas ↓</a>

  <a class="btn {{ 'active' if order=='volume_desc' else '' }}"
     href="{{ url_for('bp.public_report', ym=ym, order='volume_desc') }}">Volume ↓</a>
</div>
  </div>

  <div class="table-scroll">
    <table class="table">
      <thead>
        <tr>
          <th>Loja</th>
          <th class="num">Loja não atendeu</th>
          <th class="num">Vendas não atendeu</th>
          <th class="num">Volume total recebido</th>
          <th class="num">% Perda</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r['Loja'] }}</td>
          <td class="num">{{ r['Recebidas'] }}</td>
          <td class="num">{{ r['Perdidas'] }}</td>
          <td class="num">{{ r['Volume'] }}</td>
          <td class="num">
  {% if r['Volume']|int > 0 %}
    {% set pct = (r['pct'] or 0.0)|round(2) %}
    <span class="
      {% if pct>=15 %}chip chip--danger
      {% elif pct>=8 %}chip chip--warn
      {% else %}chip chip--ok
      {% endif %}">
      {{ "%.2f"|format(pct) }}%
    </span>
  {% else %}
    <span class="muted">—</span>
  {% endif %}
</td>

          <td>
            <a class="link" href="{{ url_for('bp.public_store_detail', ym=ym, store_slug=r['Loja']|lower|replace(' ', '-')) }}">Ver ligações</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
  .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
  .header-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
  .actions .btn { margin-left:8px; }
  .muted { color:#9aa3b2; margin: 4px 0 12px 0; }
  .order-bar { display:flex; align-items:center; gap:8px; margin-bottom:12px; }
  .pill { padding:6px 10px; border-radius:999px; border:1px solid #2b3645; color:#dbe2ea; text-decoration:none; }
  .pill.active { background:#0ea5e9; border-color:#0ea5e9; color:#fff; }
  .table-scroll { overflow:auto; border:1px solid #223047; border-radius:12px; }
  .table { width:100%; border-collapse:separate; border-spacing:0; min-width:760px;}
  .table th, .table td { padding:10px 12px; border-bottom:1px solid #1f2a3a; vertical-align:middle;}
  .table thead th { background:#17202d; position:sticky; top:0; z-index:1;}
  .num { text-align:right; white-space:nowrap; }
  .btn { padding:8px 12px; border-radius:10px; border:1px solid #2b3645; background:#0f1722; color:#e5efff; text-decoration:none; }
  .btn--success { background:#16a34a; border-color:#16a34a; color:#fff; }
  .chip { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; }
  .chip--ok { background:#1c4730; color:#b7ffd1; }
  .chip--warn { background:#4b4306; color:#fff2a1; }
  .chip--danger { background:#4b0b0b; color:#ffc0c0; }
  .link { color:#7cc4ff; text-decoration:none; }
  .link:hover { text-decoration:underline; }
</style>
{% endblock %}
