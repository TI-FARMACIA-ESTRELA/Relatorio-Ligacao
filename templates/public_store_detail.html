{% extends "base.html" %}
{% block content %}
<div class="flex items-center justify-between mb-4">
  <h2 class="text-2xl font-bold">{{ store }} — Ligações ({{ ym }})</h2>
  <a href="{{ url_for('bp.public_report', ym=ym) }}"
     class="inline-flex items-center px-3 py-1.5 rounded bg-slate-800 hover:bg-slate-700">
     ← Voltar
  </a>
</div>

<div class="filters">
  <a class="pill {{ 'active' if (filter_sel or '')=='' else '' }}" href="{{ url_for('bp.public_store_detail', ym=ym, store_slug=store|lower|replace(' ','-')) }}">todas</a>
  <a class="pill {{ 'active' if filter_sel=='atendida' else '' }}" href="{{ url_for('bp.public_store_detail', ym=ym, store_slug=store|lower|replace(' ','-'), f='atendida') }}">
    atendida
  </a>
  <a class="pill {{ 'active' if filter_sel=='expulsa' else '' }}" href="{{ url_for('bp.public_store_detail', ym=ym, store_slug=store|lower|replace(' ','-'), f='expulsa') }}">
    setor Whatsapp não atendeu
  </a>
  <a class="pill {{ 'active' if filter_sel=='Cliente desistiu' else '' }}" href="{{ url_for('bp.public_store_detail', ym=ym, store_slug=store|lower|replace(' ','-'), f='Cliente desistiu') }}">
    Cliente desistiu
  </a>
  <a class="pill {{ 'active' if filter_sel=='outros' else '' }}" href="{{ url_for('bp.public_store_detail', ym=ym, store_slug=store|lower|replace(' ','-'), f='outros') }}">
    demais status
  </a>
</div>


<div class="flex items-center gap-2 mb-4">
  <a class="chip {{ 'chip--active' if filter_sel=='atendida' else '' }}"
     href="{{ url_for('bp.public_store_detail', ym=ym, store_slug=store|lower|replace(' ','-'), f='atendida') }}">
     atendida <span class="badge">{{ badges['atendida'] }}</span>
  </a>
  <a class="chip {{ 'chip--active' if filter_sel=='expulsa' else '' }}"
     href="{{ url_for('bp.public_store_detail', ym=ym, store_slug=store|lower|replace(' ','-'), f='expulsa') }}">
     setor Whatsapp não atendeu <span class="badge">{{ badges['expulsa'] }}</span>
  </a>
  <a class="chip {{ 'chip--active' if filter_sel=='Cliente desistiu' else '' }}"
     href="{{ url_for('bp.public_store_detail', ym=ym, store_slug=store|lower|replace(' ','-'), f='Cliente desistiu') }}">
     Cliente desistiu <span class="badge">{{ badges['Cliente desistiu'] }}</span>
  </a>
  <a class="chip {{ 'chip--active' if filter_sel=='outros' else '' }}"
     href="{{ url_for('bp.public_store_detail', ym=ym, store_slug=store|lower|replace(' ','-'), f='outros') }}">
     demais status <span class="badge">{{ badges['outros'] }}</span>
  </a>
</div>

{% if volume_total > 0 %}
<p class="text-sm text-muted mb-2">
  Perdidas: <b>{{ perdidas }}</b> de <b>{{ volume_total }}</b>
  (<b>{{ '%.2f' % pct_perda_real }}%</b>)
</p>
{% else %}
<p class="text-sm text-warning mb-2">
  Volume total da loja ainda não informado. % de perda não pode ser calculada.
</p>
{% endif %}


<!-- Badges de legenda -->
<div class="flex flex-wrap gap-2 mb-3 text-xs">
  <span class="px-2 py-1 rounded bg-emerald-900/40 border border-emerald-800">atendida</span>
  <span class="px-2 py-1 rounded bg-amber-900/40 border border-amber-700">setor Whatsapp não atendeu</span>
  <span class="px-2 py-1 rounded bg-rose-900/40 border border-rose-800">Cliente desistiu</span>
  <span class="px-2 py-1 rounded bg-slate-800 border border-slate-700">demais status</span>
</div>

<div class="overflow-hidden rounded border border-slate-800">
  <table class="min-w-full text-sm">
    <thead class="bg-slate-800 text-slate-100">
      <tr>
        <th class="px-4 py-2 text-left">Data</th>
        <th class="px-4 py-2 text-left">Hora</th>
        <th class="px-4 py-2 text-left">Status</th>
      </tr>
    </thead>
    <tbody class="bg-slate-900">
      {% for r in rows %}
      {% set st = (r['Status'] or '').lower() %}
      {% set cls = 'bg-slate-900' %}
      {% if 'atendida' in st %}
        {% set cls = 'bg-emerald-900/10' %}
      {% elif 'setor Whatsapp não atendeu' in st %}
        {% set cls = 'bg-amber-900/10' %}
      {% elif 'abandona' in st %}
        {% set cls = 'bg-rose-900/10' %}
      {% endif %}
      <tr class="border-t border-slate-800 {{ cls }}">
        <td class="px-4 py-2 whitespace-nowrap">{{ r['Data'] or '-' }}</td>
        <td class="px-4 py-2 whitespace-nowrap">{{ r['Hora'] or '-' }}</td>
        <td class="px-4 py-2">{{ r['Status'] or '-' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
